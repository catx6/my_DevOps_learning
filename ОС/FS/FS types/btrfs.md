**Btrfs** (B-tree File System) - это современная копирующая при записи (Copy-on-Write, CoW) файловая система созданная для Linux как замена **ext4** с поддержкой снимков, сжатия, RAID и самовосстановления данных. ее цель быть масштабируемой, надежной и удобной для администрирования

---
#### Особенности Btrfs

1. Copy-on-Write (Cow)
	- при изменении файла Btrfs не перезаписывает старые данные, а создает новую копию измененных блоков
	- Это позволяет:
		- Делать снимки (snapshots) без дублирования данных
		- гарантированная целостность
---
2. snapshots & subvolumes
- подтом **subvolume** - это отдельная логическая часть файловой системы, похожая на независимый раздел
- snapshot - это мгновенная копия подтома
	- используется для резервного копирования, отката системы, тестирования конфигураций и т.д
	- создается мнгновенно и занимает мало место (данные копируется только при изменении)
```bash
sudo btrfs subvolume create /mnt/data/subvol1 # создать подтом
sudo btrfs subvolume snapshot /mnt/data/subvol1  /mnt/data/subvol1_snapshot
```

---

#### встроенная поддержка RAID
Btrfs умеет управлять несколькими устройствами без внешнего RAID-контроллера

| режим   | назначение                               |
| ------- | ---------------------------------------- |
| RAID0   | производительность                       |
| RAID1   | Зеркалирование данных                    |
| RAID5/6 | производительность + отказоустройчивость |
| RAID10  | компромисс скорости и надежности         |
```bash
sudo mkfs.btrfs -m raid1 -d raid1 /dev/sda /dev/sdb
```
- `-m` - метаданные
- `-d` - данные

---

#### Сжатие данных
поддержка алгоритмов: `zlib`, `zstd`, `lzo`
```bash
sudo mount -o compress=zstd /dev/sda1 /mnt/data
```
- Сжимает данные на лету, снижая нагрузку на диск и экономия данных

---
#### проверка целостности и самовосстановления 
- Каждая запись данных и метаданных имеет **контрольную сумму**
- при чтении данные проверяются, и если ошибка найдена - при наличии зеркала система восстанавливает данные автоматически
---

|Команда|Назначение|
|---|---|
|`mkfs.btrfs /dev/sdX`|Создать файловую систему|
|`btrfs filesystem df /mnt`|Показать использование места|
|`btrfs subvolume list /mnt`|Список подтомов|
|`btrfs scrub start /mnt`|Проверить и восстановить повреждённые данные|
|`btrfs balance start /mnt`|Балансировка устройств|
|`btrfs device add/remove`|Добавление/удаление дисков|

----

### ⚠️ Недостатки

- ⚠️ RAID5/6 — **нестабильны**, использовать не рекомендуется;
- ⚠️ Некоторая потеря производительности из-за CoW;
- ⚠️ Более сложная структура метаданных по сравнению с ext4.